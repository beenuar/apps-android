package com.deepfakeshield.av.engine

import android.content.Context
import androidx.test.core.app.ApplicationProvider
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config
import java.io.File

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [28])
class HeuristicMalwareAnalyzerTest {

    private lateinit var analyzer: HeuristicMalwareAnalyzer

    @Before
    fun setup() {
        val context = ApplicationProvider.getApplicationContext<Context>()
        analyzer = HeuristicMalwareAnalyzer(context)
    }

    @Test
    fun `suspicious extension flagged`() {
        val file = File.createTempFile("test", ".exe").apply { writeBytes(ByteArray(100)) }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertTrue(result.indicators.any { it.title.contains("Executable") || it.title.contains("Code") })
        file.delete()
    }

    @Test
    fun `double extension trick detected`() {
        val file = File.createTempFile("document.pdf", ".exe").apply { writeBytes(ByteArray(100)) }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertTrue(result.indicators.any { it.title.contains("Double Extension") })
        assertEquals(ThreatLevel.SUSPICIOUS, result.threatLevel)
        file.delete()
    }

    @Test
    fun `tiny APK flagged`() {
        val file = File.createTempFile("dropper", ".apk").apply { writeBytes(ByteArray(50_000)) }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertTrue(result.indicators.any { it.title.contains("Tiny APK") })
        file.delete()
    }

    @Test
    fun `ransomware extension produces infected`() {
        val file = File.createTempFile("files", ".locky").apply { writeBytes(ByteArray(1000)) }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertEquals(ThreatLevel.INFECTED, result.threatLevel)
        assertTrue(result.threatName?.contains("Ransomware") == true || result.threatName == "Ransomware")
        file.delete()
    }

    @Test
    fun `clean text file does not produce infected or PUA`() {
        val file = File.createTempFile("notes", ".txt").apply {
            writeText("Normal documentation file content.")
        }
        val result = analyzer.analyzeFile(file, "/sdcard/Download/notes.txt")
        assertFalse(result.threatLevel == ThreatLevel.INFECTED || result.threatLevel == ThreatLevel.PUA)
        file.delete()
    }

    @Test
    fun `PUA filename flagged`() {
        val file = File.createTempFile("crack_me", ".apk").apply { writeBytes(ByteArray(200_000)) }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertTrue(result.indicators.any { it.title.contains("PUA") } || result.threatLevel == ThreatLevel.PUA)
        file.delete()
    }

    @Test
    fun `high entropy file flagged`() {
        val file = File.createTempFile("data", ".bin").apply {
            writeBytes(ByteArray(2048) { kotlin.random.Random.nextInt().toByte() })
        }
        val result = analyzer.analyzeFile(file, file.absolutePath)
        assertTrue(result.indicators.any { it.title.contains("Entropy") } || result.threatLevel == ThreatLevel.CLEAN)
        file.delete()
    }
}
