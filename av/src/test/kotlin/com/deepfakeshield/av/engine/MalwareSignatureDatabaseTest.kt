package com.deepfakeshield.av.engine

import android.content.Context
import androidx.test.core.app.ApplicationProvider
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config
import java.io.File

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [28])
class MalwareSignatureDatabaseTest {

    private lateinit var db: MalwareSignatureDatabase

    @Before
    fun setup() {
        val context = ApplicationProvider.getApplicationContext<Context>()
        db = MalwareSignatureDatabase(context)
    }

    @Test
    fun `unknown hash returns null`() {
        val result = db.lookupHash("a".repeat(64))
        assertNull(result)
    }

    @Test
    fun `file with metasploit string matches byte pattern`() {
        val file = File.createTempFile("test", ".bin").apply {
            writeText("metasploit payload dropper")
        }
        val match = db.scanBytePatterns(file)
        assertNotNull(match)
        assertTrue(match!!.contains("metasploit") || match.contains("payload"))
        file.delete()
    }

    @Test
    fun `file with encrypted content matches`() {
        val file = File.createTempFile("test", ".bin").apply {
            writeText("this file is encrypted and obfuscated")
        }
        val match = db.scanBytePatterns(file)
        assertNotNull(match)
        assertTrue(match!!.contains("encrypt") || match.contains("obfuscate"))
        file.delete()
    }

    @Test
    fun `file with screenshot keyword matches`() {
        val file = File.createTempFile("test", ".bin").apply {
            writeText("capture screenshot and location data")
        }
        val match = db.scanBytePatterns(file)
        assertNotNull(match)
        assertTrue(match!!.contains("screenshot") || match.contains("location"))
        file.delete()
    }

    @Test
    fun `file with shell pattern matches`() {
        val file = File.createTempFile("test", ".bin").apply {
            writeBytes("/bin/sh".toByteArray())
        }
        val match = db.scanBytePatterns(file)
        assertNotNull(match)
        file.delete()
    }

    @Test
    fun `file with ransomware pattern matches`() {
        val file = File.createTempFile("test", ".enc").apply {
            writeBytes("encrypt".toByteArray())
        }
        val match = db.scanBytePatterns(file)
        assertNotNull(match)
        assertTrue(match!!.contains("encrypt") || match.contains("ransom"))
        file.delete()
    }

    @Test
    fun `clean file returns null`() {
        val file = File.createTempFile("test", ".txt").apply {
            writeText("Hello world - clean text only")
        }
        val match = db.scanBytePatterns(file)
        assertNull(match)
        file.delete()
    }

    @Test
    fun `scanAllBytePatterns returns multiple matches for multi-pattern file`() {
        val file = File.createTempFile("test", ".bin").apply {
            writeBytes("encrypt decrypt ransom".toByteArray())
        }
        val matches = db.scanAllBytePatterns(file)
        assertTrue(matches.size >= 1)
        file.delete()
    }

    @Test
    fun `empty file returns null`() {
        val file = File.createTempFile("test", ".empty").apply {
            writeBytes(ByteArray(0))
        }
        val match = db.scanBytePatterns(file)
        assertNull(match)
        file.delete()
    }
}
