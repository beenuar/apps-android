#!/usr/bin/env python3
"""
Fetches SHA256 malware hashes from open-source threat intelligence feeds.
Output: one hash per line (64 hex chars) for use in malware_hashes.txt

Sources:
- OSINT DigitalSide/Threat-Intel (JSON) - https://github.com/davidonzo/Threat-Intel
"""
import json
import urllib.request
import sys
import os

# Threat-Intel JSON - lookup entries contain sha256
THREAT_INTEL_URL = "https://osint.digitalside.it/Threat-Intel/lists/latest-hashes.json"
# Alternative: GitHub raw (sometimes lags)
THREAT_INTEL_GITHUB = "https://raw.githubusercontent.com/davidonzo/Threat-Intel/master/lists/latesthashes.json"

def fetch_json(url: str) -> dict:
    req = urllib.request.Request(url, headers={"User-Agent": "DeepfakeShield/1.0"})
    with urllib.request.urlopen(req, timeout=30) as r:
        return json.loads(r.read().decode())

def extract_sha256_from_threat_intel(data: dict) -> set:
    hashes = set()
    lookup = data.get("lookup", {})
    for entry_id, entry in lookup.items():
        if isinstance(entry, dict) and "sha256" in entry:
            h = entry["sha256"].strip().lower()
            if len(h) == 64 and all(c in "0123456789abcdef" for c in h):
                hashes.add(h)
    return hashes

def main():
    output_path = os.path.join(os.path.dirname(__file__), "..", "av", "src", "main", "assets", "malware_hashes.txt")
    all_hashes = set()

    for url in [THREAT_INTEL_URL, THREAT_INTEL_GITHUB]:
        try:
            print(f"Fetching from {url}...")
            data = fetch_json(url)
            hashes = extract_sha256_from_threat_intel(data)
            all_hashes.update(hashes)
            print(f"  Extracted {len(hashes)} SHA256 hashes (total: {len(all_hashes)})")
        except Exception as e:
            print(f"  Failed: {e}")

    if not all_hashes:
        print("No hashes extracted. Using minimal fallback sample set.")
        # Fallback: known malware hashes from public OSINT (Threat-Intel sample)
        all_hashes = {"f6c97b1e2ed02578ca1066c8235ba4f991e645f89012406c639dbccc6582eec8"}

    # Limit to reasonable size for bundled asset (~10k hashes)
    hashes_list = sorted(all_hashes)[:12000]

    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    with open(output_path, "w") as f:
        f.write("# Malware SHA256 hashes - open-source threat intel. One hash per line.\n")
        f.write("# Format: 64 hex chars. Lines starting with # ignored.\n")
        f.write("# Generated by scripts/fetch_malware_hashes.py\n")
        for h in hashes_list:
            f.write(h + "\n")

    print(f"Written {len(hashes_list)} hashes to {output_path}")
    return 0

if __name__ == "__main__":
    sys.exit(main())
